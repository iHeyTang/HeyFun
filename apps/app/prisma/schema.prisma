// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

generator json {
  // Read more: https://github.com/arthurfiorette/prisma-json-types-generator
  provider = "prisma-json-types-generator"
  allowAny = "true"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users are now managed by Clerk, no need for a local Users table

model Organizations {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ownerId   String
  personal  Boolean

  @@index([createdAt])
  @@index([ownerId])
}

model Preferences {
  id                  String   @id @default(cuid())
  organizationId      String   @unique
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  language            String?
  /// [ModelInfo]
  defaultChatbotModel Json?
  /// [ModelInfo]
  defaultAgentModel   Json?
}

model OrganizationUsers {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([organizationId, userId])
  @@index([userId])
}

model Tasks {
  id             String           @id @default(cuid())
  outId          String?          @unique
  llmId          String
  summary        String?
  prompt         String           @db.Text
  status         String           @default("pending")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organizationId String
  tools          Json             @default("[]")
  shareExpiresAt DateTime?
  progresses     TaskProgresses[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([createdAt])
}

model TaskProgresses {
  id             String   @id @default(cuid())
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  taskId         String
  index          Int
  round          Int      @default(1)
  step           Int
  type           String
  content        Json

  task Tasks @relation(fields: [taskId], references: [id])

  @@index([organizationId])
  @@index([organizationId, taskId])
  @@index([type])
  @@index([createdAt])
}

// @deprecated - 已废弃，新架构中不再使用
// Provider 配置已通过环境变量管理，模型配置在代码中统一维护
model LlmConfigs {
  id             String   @id @default(cuid())
  type           String
  model          String
  baseUrl        String
  apiKey         String
  maxTokens      Int
  maxInputTokens Int?
  temperature    Float
  apiType        String
  apiVersion     String?
  isActive       Boolean
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  name           String?

  @@index([organizationId])
  @@index([isActive])
}

// @deprecated - 已废弃，新架构中不再使用
// Provider 配置（API Keys）通过环境变量管理，不需要数据库存储
model ModelProviderConfigs {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  // provider id, identify certain provider, such as "openai"
  provider       String
  // if true, this is the default config for the same type of provider. it not used for now because we only have one config for each provider.
  isDefault      Boolean  @default(false)
  // config is a encrypted string, it contains the config for the provider. each provider has its own config schema.
  config         String   @db.Text

  @@index([organizationId])
  @@index([provider])
}

model AigcProviderConfigs {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  provider       String
  // config is a encrypted string, it contains the config for the provider. each provider has its own config schema.
  config         String   @db.Text

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@index([provider])
}

model Agents {
  id                   String   @id @default(cuid())
  name                 String
  description          String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  organizationId       String
  systemPromptTemplate String?
  /// [JSONSchema] String[]
  tools                Json     @default("[]")
  /// [JSONSchema] Object with system, plan, next template strings
  promptTemplates      Json?
  isDefault            Boolean  @default(false)

  @@index([organizationId])
  @@index([createdAt])
  @@index([organizationId, isDefault])
}

model McpServerConfigs {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organizationId  String
  name            String
  encryptedConfig String   @db.Text

  @@index([organizationId])
  @@index([createdAt])
}

enum AgentToolSource {
  STANDARD
  CUSTOM
}

model AgentTools {
  id             String          @id @default(cuid())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId String
  name           String?
  source         AgentToolSource
  schemaId       String?
  // for stdio
  env            String?
  // for sse
  query          String?
  headers        String?
  // for custom
  customConfig   String?

  schema ToolSchemas? @relation(fields: [schemaId], references: [id])

  @@unique([schemaId, organizationId])
  @@index([schemaId])
  @@index([organizationId])
  @@index([createdAt])
}

model ToolSchemas {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  name          String   @unique
  description   String?  @db.Text
  repoUrl       String?
  /// Command for stdio
  command       String   @default("")
  /// [StringList] Args for stdio
  args          Json     @default("[]")
  /// [JSONSchema] EnvSchema for stdio
  envSchema     Json     @default("{}")
  /// Url for sse
  url           String   @default("")
  /// QuerySchema for sse
  querySchema   Json     @default("{}")
  /// [JSONSchema] HeadersSchema for sse
  headersSchema Json     @default("{}")

  // Enhanced fields for richer display
  logoUrl      String? // Logo/icon URL
  sourceUrl    String? // Source/homepage URL (GitHub, npm, etc.)
  author       String? // Tool author/maintainer
  version      String? // Current version
  license      String? // License type
  category     String? // Tool category (e.g., "development", "productivity", "ai")
  tags         Json      @default("[]") // [StringList] Tags for categorization
  /// [JSONSchema] Capabilities/tools provided by this MCP server
  capabilities Json      @default("[]")
  downloads    Int? // Download count if available
  stars        Int? // GitHub stars or similar rating
  lastUpdated  DateTime? // Last update from source
  readme       String?   @db.Text // Cached README content
  /// [JSONSchema] Additional metadata
  metadata     Json      @default("{}")

  AgentTools AgentTools[]

  @@index([name])
  @@index([createdAt])
  @@index([category])
  @@index([author])
}

model PaintboardTasks {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String

  // 任务基本信息
  service        String // 服务提供商：wan, doubao, jimeng
  model          String // 模型名称
  generationType String // 生成类型：text-to-image, image-to-image, text-to-video, image-to-video, keyframe-to-video
  /// [PaintboardTaskStatus]
  status         String @default("pending") // 任务状态：pending, processing, completed, failed

  // 任务参数和结果
  /// [PaintboardTaskParams]
  params  Json // 任务参数
  taskId  String? // 外部服务返回的任务ID
  /// [PaintboardTaskResult]
  results Json    @default("[]") // 结果数组，包含文件路径等信息

  // 错误信息
  error String? // 错误信息

  // 索引
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([createdAt])
  @@index([service, model])
}

model ChatSessions {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // 软删除时间戳，用于审计
  organizationId String

  // 会话信息
  title         String? // 会话标题，可由第一条消息自动生成
  modelProvider String? // 模型提供商（已废弃，保留用于兼容性）
  modelId       String? // 模型ID（已废弃，保留用于兼容性，实际使用消息中的 modelId）
  agentId       String? // 关联的Agent ID，不传则使用默认对话

  // 会话状态
  /// [ChatSessionStatus]
  status String @default("idle") // 处理状态：idle（空闲）, pending（挂起，准备执行）, processing（正在执行）, failed（执行失败）

  // 关联的消息
  messages ChatMessages[]

  // 上下文管理相关
  contextSnapshots       ContextSnapshots[]
  contextManagementState ContextManagementStates?

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, deletedAt])
  @@index([createdAt])
  @@index([agentId])
  @@index([deletedAt])
}

model ChatMessages {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  sessionId      String
  organizationId String

  // 消息信息
  role    String // 角色：user, assistant, system, tool
  content String @db.Text // 消息内容

  // 流式输出相关
  isStreaming Boolean @default(false) // 是否正在流式输出
  isComplete  Boolean @default(false) // 是否完成输出

  // 元数据
  tokenCount         Int? // token数量（总数，向后兼容）
  inputTokens        Int? // 输入token数量
  outputTokens       Int? // 输出token数量
  cachedInputTokens  Int? // 缓存的输入token数量
  cachedOutputTokens Int? // 缓存的输出token数量
  finishReason       String? // 完成原因
  modelId            String? // 模型ID（仅用于assistant消息，标识该消息由哪个模型生成）

  // 工具调用相关
  /// [ToolCall[]]
  toolCalls   Json? // AI返回的工具调用
  /// [ToolResult[]]
  toolResults Json? // AI返回的工具结果

  // 微代理执行详情
  /// [MicroAgentExecutionDetail[]]
  microAgentExecutions Json? // 微代理执行详情列表

  // 关联的会话
  session ChatSessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([role])
}

model FlowCanvasProjects {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  name           String
  schema         Json

  // 关联的 Agent 会话
  agentSessions FlowCanvasProjectAgentSessions[]

  @@index([organizationId])
  @@index([createdAt])
  @@index([name])
  @@index([organizationId, name])
}

// FlowCanvas 项目的 Agent 会话
// 每个 FlowCanvas 项目可以有多个独立的 Agent 会话
model FlowCanvasProjectAgentSessions {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String

  // 关联的 FlowCanvas 项目
  projectId String
  project   FlowCanvasProjects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // 会话信息
  title   String? // 会话标题，可由第一条消息自动生成
  modelId String // 模型ID
  agentId String? // 关联的Agent ID，不传则使用默认 Coordinator

  // 会话状态
  status String @default("active") // 会话状态：active, archived

  // 关联的消息
  messages FlowCanvasProjectAgentMessages[]

  @@index([organizationId])
  @@index([projectId])
  @@index([organizationId, projectId])
  @@index([organizationId, status])
  @@index([createdAt])
  @@index([agentId])
}

// FlowCanvas Agent 会话的消息
model FlowCanvasProjectAgentMessages {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  sessionId      String
  organizationId String

  // 消息信息
  role    String // 角色：user, assistant, system, tool
  content String @db.Text // 消息内容

  // 流式输出相关
  isStreaming Boolean @default(false) // 是否正在流式输出
  isComplete  Boolean @default(false) // 是否完成输出

  // 元数据
  tokenCount   Int? // token数量
  finishReason String? // 完成原因
  modelId      String? // 模型ID（仅用于assistant消息，标识该消息由哪个模型生成）

  // 工具调用相关
  /// [ToolCall[]]
  toolCalls   Json? // AI返回的工具调用
  /// [ToolResult[]]
  toolResults Json? // AI返回的工具结果

  // 关联的会话
  session FlowCanvasProjectAgentSessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([role])
}

// 音色管理
model Voices {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organizationId  String
  // 基本信息
  name            String
  description     String?
  // 提供商信息
  provider        String // 提供商标识
  model           String? // 使用的模型
  /// [StringList] 标签
  tags            Json     @default("[]")
  // 音频相关
  previewAudio    String? // 预览音频URL
  sourceAudio     String? // 源音频URL（用于克隆）
  // 外部音色ID
  externalVoiceId String? // 在第三方平台的音色ID
  // 额外配置
  /// [JSONSchema] 额外的provider特定配置
  extra           Json?
  // 状态
  status          String   @default("active") // active, creating, failed

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([provider])
  @@index([createdAt])
  @@index([name])
}

// 音色克隆任务
model VoiceCloneTasks {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organizationId  String
  // 任务信息
  name            String
  description     String?
  provider        String
  status          String   @default("pending") // pending, processing, completed, failed
  // 音频文件
  /// [StringList] 音频文件URLs
  audioFiles      Json     @default("[]")
  // 配置参数
  /// [JSONSchema] 额外参数
  params          Json?
  // 结果
  voiceId         String? // 关联生成的Voice ID
  externalVoiceId String? // 第三方平台返回的音色ID
  error           String?  @db.Text

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([provider])
  @@index([createdAt])
}

model Credit {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String   @unique
  amount         Int      @default(0)

  @@index([organizationId])
  @@index([createdAt])
}

// 音色管理
model SystemVoices {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  // 基本信息
  name            String
  description     String?
  // 提供商信息
  provider        String // 提供商标识
  model           String? // 使用的模型
  /// [StringList] 标签
  tags            Json     @default("[]")
  /// 音频
  audio           String   @default("")
  // 外部音色ID
  externalVoiceId String? // 在第三方平台的音色ID
  // 额外配置
  /// [JSONSchema] 额外的provider特定配置
  extra           Json?
  // 状态
  status          String   @default("active") // active, creating, failed

  @@index([provider])
  @@index([createdAt])
  @@index([name])
}

// Gateway API密钥管理
model GatewayApiKeys {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  organizationId String
  // 密钥信息
  name           String // 密钥名称
  keyPrefix      String // 密钥前缀（用于显示，如 sk-xxxx）
  encryptedKey   String    @db.Text // 加密后的完整密钥
  // 状态和权限
  isActive       Boolean   @default(true)
  expiresAt      DateTime? // 过期时间
  // 使用限制
  rateLimit      Int? // 每分钟请求数限制
  // 元数据
  lastUsedAt     DateTime? // 最后使用时间
  description    String?   @db.Text

  // 关联的使用记录
  usageRecords GatewayUsageRecords[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([keyPrefix])
  @@index([createdAt])
}

// Gateway使用量统计
model GatewayUsageRecords {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  organizationId String
  apiKeyId       String? // 可选，Clerk 鉴权模式下为 null
  // 请求信息
  modelId        String // 使用的模型ID
  endpoint       String // 端点路径
  method         String // HTTP方法
  // Token使用量
  inputTokens    Int      @default(0)
  outputTokens   Int      @default(0)
  totalTokens    Int      @default(0)
  // 请求元数据
  statusCode     Int? // HTTP状态码
  responseTime   Int? // 响应时间（毫秒）
  errorMessage   String?  @db.Text // 错误信息
  // IP地址（可选，用于安全审计）
  ipAddress      String?

  apiKey GatewayApiKeys? @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([apiKeyId])
  @@index([organizationId, createdAt])
  @@index([modelId])
  @@index([createdAt])
}

// Gateway模型配置（允许组织自定义模型可见性和配置）
model GatewayModelConfigs {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  // 模型信息
  modelId        String // 模型ID
  // 配置
  isEnabled      Boolean  @default(true) // 是否启用
  isVisible      Boolean  @default(true) // 是否在列表中可见
  // 自定义配置
  /// [JSONSchema] 自定义配置（如自定义名称、描述等）
  customConfig   Json?
  // 使用限制
  rateLimit      Int? // 该模型的速率限制
  maxTokens      Int? // 最大token限制

  @@unique([organizationId, modelId])
  @@index([organizationId])
  @@index([organizationId, isEnabled])
  @@index([modelId])
}

// 系统模型定义表（系统级配置，所有组织共享）
model SystemModelDefinitions {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基础信息
  modelId     String  @unique // 模型唯一标识符（格式：provider/model-name）
  name        String // 模型显示名称
  provider    String // 提供商名称
  family      String // 模型家族，用于显示不同的图标
  type        String? // 模型类型：language, embedding, image
  description String? @db.Text // 模型描述

  // 能力信息
  contextLength           Int? // 上下文长度（tokens）
  supportsStreaming       Boolean @default(false) // 是否支持流式输出
  supportsFunctionCalling Boolean @default(false) // 是否支持函数调用
  supportsVision          Boolean @default(false) // 是否支持视觉/多模态

  // 定价信息（JSON格式存储）
  /// [ModelPricing]
  pricing Json?

  // 状态信息
  enabled Boolean @default(false) // 是否启用（默认未启用，需要用户手动启用）

  // 元数据（JSON格式存储）
  /// [JSONSchema]
  metadata Json?

  @@index([modelId])
  @@index([provider])
  @@index([family])
  @@index([type])
  @@index([enabled])
  @@index([createdAt])
}

// 系统提示词片段（System Prompt Snippets）
// 用于动态组装 Agent 的系统提示词
// 系统级别，不属于任何租户
model SystemPromptSnippets {
  id                 String    @id @default(cuid())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  // 基本信息
  name               String
  description        String
  enabled            Boolean   @default(true)
  content            String    @db.Text
  // 元数据
  version            String?
  author             String?
  category           String? // syntax, guideline, rule, example, knowledge, format, other
  section            String? // 所属章节
  /// [String[]]
  tags               Json      @default("[]") // 标签数组，用于检索匹配
  contentUpdatedAt   DateTime? // 内容最后更新时间（仅当 name, description, content, category, tags 更新时更新）
  // Embedding 状态
  embeddingStatus    String    @default("pending") // pending: 待处理, processing: 处理中, completed: 已完成, failed: 失败
  embeddingVersion   String? // 当前 embedding 对应的版本号
  embeddingError     String?   @db.Text // 如果失败，存储错误信息
  embeddingUpdatedAt DateTime? // embedding 最后更新时间

  @@index([enabled])
  @@index([category])
  @@index([createdAt])
  @@index([embeddingStatus])
  @@index([embeddingStatus, enabled])
}

// ============================================
// Context Management Module - 上下文管理模块
// ============================================

// 上下文快照表：存储压缩后的上下文摘要
model ContextSnapshots {
  id             String   @id @default(cuid())
  sessionId      String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 快照信息
  version      Int    @default(1) // 快照版本号
  snapshotType String @default("compression") // 快照类型：compression, summary, key_points
  strategy     String @default("hybrid") // 使用的策略：sliding_window, summary_compression, hybrid

  // 压缩信息
  originalMessageCount   Int // 原始消息数量
  compressedMessageCount Int // 压缩后消息数量
  originalTokenCount     Int? // 原始 token 数量
  compressedTokenCount   Int? // 压缩后 token 数量

  // 内容
  summary            String? @db.Text // 对话摘要
  /// [String[]]
  keyPoints          Json    @default("[]") // 关键信息点列表
  preservedContext   String? @db.Text // 保留的上下文信息
  /// [String[]]
  importantDecisions Json    @default("[]") // 重要决策列表

  // 元数据
  /// [JSONSchema]
  metadata Json @default("{}") // 其他元数据

  // 关联的会话
  session ChatSessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([sessionId, version])
}

// 上下文管理状态表：存储会话的上下文管理状态
model ContextManagementStates {
  id             String   @id @default(cuid())
  sessionId      String   @unique
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 当前上下文状态
  currentMessageCount Int     @default(0) // 当前消息数量
  currentTokenCount   Int     @default(0) // 当前 token 数量
  lastSnapshotId      String? // 最后一次快照的 ID
  lastSnapshotVersion Int     @default(1) // 最后一次快照的版本

  // 管理配置
  maxMessages       Int    @default(30) // 最大消息数量
  maxTokens         Int    @default(8000) // 最大 token 数量
  slidingWindowSize Int    @default(10) // 滑动窗口大小
  strategy          String @default("hybrid") // 使用的策略

  // 统计信息
  totalCompressions Int @default(0) // 总压缩次数
  totalTokensSaved  Int @default(0) // 总共节省的 token 数

  // 关联的会话
  session ChatSessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([organizationId])
}

// ============================================
// Notes Module - 笔记模块
// ============================================

// 笔记文件夹
model NoteFolders {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  name           String
  parentId       String? // 支持嵌套文件夹
  order          Int      @default(0) // 排序顺序

  // 关联关系
  parent   NoteFolders?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children NoteFolders[] @relation("FolderHierarchy")
  notes    Notes[]

  @@index([organizationId])
  @@index([organizationId, parentId])
  @@index([parentId])
  @@index([createdAt])
}

// 笔记标签
model NoteTags {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  name           String
  color          String? // 标签颜色（hex 格式，如 #FF5733）
  order          Int      @default(0) // 排序顺序

  // 关联关系
  noteRelations NoteTagRelations[]

  @@unique([organizationId, name]) // 同一组织内标签名唯一
  @@index([organizationId])
  @@index([organizationId, name])
  @@index([createdAt])
}

// 笔记核心表
model Notes {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  organizationId String
  title          String
  /// [String] OSS 文件 key，存储 Markdown 内容
  contentKey     String
  /// [String] 内容纯文本（用于搜索），从 Markdown 提取
  contentText    String?   @db.Text
  /// [String] 内容哈希值（用于版本控制和去重）
  contentHash    String?
  folderId       String? // 所属文件夹
  isPinned       Boolean   @default(false) // 是否置顶
  isStarred      Boolean   @default(false) // 是否收藏
  isArchived     Boolean   @default(false) // 是否归档
  isDeleted      Boolean   @default(false) // 是否删除（软删除）
  deletedAt      DateTime? // 删除时间
  order          Int       @default(0) // 排序顺序

  // 关联关系
  folder       NoteFolders?       @relation(fields: [folderId], references: [id], onDelete: SetNull)
  tagRelations NoteTagRelations[]
  links        NoteLinks[]        @relation("SourceNote")
  backLinks    NoteLinks[]        @relation("TargetNote")
  attachments  NoteAttachments[]
  versions     NoteVersions[]
  // 注意：全文搜索索引需要在数据库迁移中单独创建
  // 可以使用 PostgreSQL 的 tsvector 或 pg_trgm 扩展

  @@index([organizationId])
  @@index([organizationId, folderId])
  @@index([organizationId, isDeleted])
  @@index([organizationId, isPinned])
  @@index([organizationId, isStarred])
  @@index([organizationId, isArchived])
  @@index([folderId])
  @@index([createdAt])
  @@index([updatedAt])
}

// 笔记-标签关联表
model NoteTagRelations {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  noteId    String
  tagId     String

  // 关联关系
  note Notes    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag  NoteTags @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([noteId, tagId]) // 防止重复关联
  @@index([noteId])
  @@index([tagId])
  @@index([createdAt])
}

// 笔记双向链接
model NoteLinks {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  organizationId String
  sourceNoteId   String // 源笔记
  targetNoteId   String // 目标笔记
  linkType       String   @default("bidirectional") // bidirectional, unidirectional

  // 关联关系
  sourceNote Notes @relation("SourceNote", fields: [sourceNoteId], references: [id], onDelete: Cascade)
  targetNote Notes @relation("TargetNote", fields: [targetNoteId], references: [id], onDelete: Cascade)

  @@unique([sourceNoteId, targetNoteId]) // 防止重复链接
  @@index([organizationId])
  @@index([organizationId, sourceNoteId])
  @@index([organizationId, targetNoteId])
  @@index([sourceNoteId])
  @@index([targetNoteId])
  @@index([createdAt])
}

// 笔记附件
model NoteAttachments {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  noteId         String
  fileKey        String // OSS 文件 key
  fileName       String // 原始文件名
  fileType       String // MIME 类型
  fileSize       Int // 文件大小（字节）

  // 关联关系
  note Notes @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, noteId])
  @@index([noteId])
  @@index([createdAt])
}

// 笔记版本历史（Phase 3 功能）
model NoteVersions {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  noteId      String
  /// [String] OSS 文件 key，存储该版本的 Markdown 内容
  contentKey  String
  /// [String] 内容哈希值
  contentHash String?
  /// [String] 版本描述（可选）
  description String?
  /// [String] 创建版本的用户 ID（可选）
  createdBy   String?

  // 关联关系
  note Notes @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([noteId, createdAt])
  @@index([createdAt])
}

// ============================================
// Assets Module - 素材管理模块
// ============================================

// 素材表：存储 agent session 产出的各种素材（图片/视频/文档/PPT等）
model Assets {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // 软删除时间戳

  organizationId String

  // Session关联（支持两种session类型）
  sessionId      String // ChatSessions 或 FlowCanvasProjectAgentSessions 的 ID
  sessionType    String // 'chat' | 'flowcanvas'

  // 文件信息
  type           String // 素材类型：image, video, document, presentation, audio, code, other
  fileKey        String // OSS文件路径，格式：${organizationId}/assets/${sessionId}/${id}/文件名
  fileName       String // 原始文件名
  fileSize       Int // 文件大小（字节）
  mimeType       String // MIME类型

  // 元数据
  title          String? // 素材标题
  description    String? @db.Text // 描述
  /// [String[]] 标签数组
  tags           Json    @default("[]")
  /// 其他元数据（JSON格式，可用于存储外部资源的原始URL等信息）
  metadata       Json    @default("{}")

  // 关联的工具调用信息（可选，用于追踪素材来源）
  toolCallId     String? // 生成该素材的工具调用ID
  messageId      String? // 关联的消息ID

  @@index([organizationId])
  @@index([organizationId, sessionId, sessionType])
  @@index([organizationId, type])
  @@index([organizationId, deletedAt])
  @@index([sessionId, sessionType])
  @@index([createdAt])
  @@index([toolCallId])
  @@index([messageId])
}

// ============================================
// Environment Variables Module - 环境变量模块
// ============================================

// 环境变量配置表：存储租户级别的环境变量配置
model EnvironmentVariables {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String   @unique
  /// [JSONSchema] 环境变量配置，JSON 格式存储，例如：{ "AMAP_API_KEY": "xxx", "FEISHU_API_KEY": "xxx" }
  variables      Json     @default("{}")

  @@index([organizationId])
  @@index([createdAt])
}
